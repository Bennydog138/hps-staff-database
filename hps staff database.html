<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hiltop Primary Staff Database</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA1jqHbtA4CoH-Ud8vEFoHcHNskhNB78mc",
      authDomain: "hiltop-primary.firebaseapp.com",
      projectId: "hiltop-primary",
      storageBucket: "hiltop-primary.appspot.com",
      messagingSenderId: "291587760601",
      appId: "1:291587760601:web:f733472e876e87b3cb79c8",
      measurementId: "G-H114JLG8ZE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let staffList = [];
    const adminCode = "admin123";

    // ---- Login ----
    function login() {
      const code = document.getElementById("loginCode").value;
      if (code === adminCode) {
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("homePage").classList.remove("hidden");
        listenToStaff();
      } else {
        alert("Invalid admin code");
      }
    }

    // ---- Real-time listener ----
    function listenToStaff() {
      const staffCol = collection(db, "staff");
      onSnapshot(staffCol, (snapshot) => {
        staffList = [];
        snapshot.forEach(docSnap => {
          staffList.push({ id: docSnap.id, ...docSnap.data() });
        });
        renderStaffTable();
      });
    }

    // ---- Render staff table ----
    function renderStaffTable() {
      const tbody = document.getElementById("staffTableBody");
      tbody.innerHTML = "";
      staffList.forEach((s, idx) => {
        const row = document.createElement("tr");
        row.className = idx % 2 === 0 ? "bg-white" : "bg-gray-50";
        row.innerHTML = `
          <td class='px-4 py-2'>${s.teachingName}</td>
          <td class='px-4 py-2'>${s.discord}</td>
          <td class='px-4 py-2'>${s.roblox}</td>
          <td class='px-4 py-2'>${s.rank}</td>
          <td class='px-4 py-2'>${s.dateHired}</td>
          <td class='px-4 py-2'><button class='bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600' onclick="viewStaff(${idx})">Open</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    // ---- Add staff ----
    async function addStaff() {
      const staff = {
        teachingName: document.getElementById("teachingName").value,
        discord: document.getElementById("discord").value,
        roblox: document.getElementById("roblox").value,
        rank: document.getElementById("rank").value,
        dateHired: document.getElementById("dateHired").value,
        notes: [],
        punishments: []
      };
      await addDoc(collection(db, "staff"), staff);
      alert("Staff added!");
      document.getElementById("addStaffForm").reset();
    }

    // ---- View staff ----
    window.viewStaff = function(index) {
      const s = staffList[index];
      document.getElementById("homePage").classList.add("hidden");
      document.getElementById("staffPage").classList.remove("hidden");

      function renderPunishments(staff) {
        return (staff.punishments || []).map((p, i) => `
          <li class="flex justify-between items-center">
            <span>${p.type} - ${p.date} - ${p.reason}</span>
            <button class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600" onclick='removePunishment("${staff.id}", ${i})'>Remove</button>
          </li>
        `).join("");
      }

      function renderStaffDetails() {
        document.getElementById("staffDetails").innerHTML = `
          <div class='bg-white shadow rounded p-6'>
            <h3 class='text-2xl font-bold mb-4'>${s.teachingName}</h3>
            <p><b>Discord:</b> ${s.discord}</p>
            <p><b>Roblox:</b> ${s.roblox}</p>
            <p><b>Rank:</b> ${s.rank}</p>
            <p><b>Date Hired:</b> ${s.dateHired}</p>

            <h4 class='text-xl font-semibold mt-4'>Notes</h4>
            <ul class='list-disc pl-5'>${s.notes.map(n => `<li>${n}</li>`).join("")}</ul>
            <div class='mt-2 flex gap-2'>
              <input id='noteInput' class='border p-2 rounded w-full' placeholder='Add note'>
              <button class='bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600' onclick='addNote("${s.id}")'>Add</button>
            </div>

            <h4 class='text-xl font-semibold mt-4'>Punishments</h4>
            <ul id="punishmentsList" class='list-disc pl-5'>${renderPunishments(s)}</ul>
            <div class='mt-2 flex gap-2'>
              <select id='punishType' class='border p-2 rounded'>
                <option value='Warning'>Warning</option>
                <option value='Strike'>Strike</option>
                <option value='Demotion'>Demotion</option>
                <option value='Other'>Other</option>
              </select>
              <input id='punishDate' type='date' class='border p-2 rounded'>
              <input id='punishReason' placeholder='Reason' class='border p-2 rounded w-full'>
              <button class='bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600' onclick='addPunishment("${s.id}")'>Add Punishment</button>
            </div>

            <div class='mt-6 flex gap-2'>
              <button class='bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600' onclick='deleteStaff("${s.id}")'>Delete</button>
              <button class='bg-gray-300 px-3 py-1 rounded hover:bg-gray-400' onclick='backHome()'>Back</button>
            </div>
          </div>
        `;
      }

      renderStaffDetails();

      // Real-time updates for this staff member
      const staffDoc = doc(db, "staff", s.id);
      onSnapshot(staffDoc, (docSnap) => {
        if (!docSnap.exists()) return backHome();
        s.notes = docSnap.data().notes || [];
        s.punishments = docSnap.data().punishments || [];
        renderStaffDetails();
      });
    }

    // ---- Add note ----
    window.addNote = async function(id) {
      const note = document.getElementById("noteInput").value;
      if (!note) return;
      const staff = staffList.find(s => s.id === id);
      const updatedNotes = [...(staff.notes || []), note];
      await updateDoc(doc(db, "staff", id), { notes: updatedNotes });
    }

    // ---- Add punishment ----
    window.addPunishment = async function(id) {
      const type = document.getElementById("punishType").value;
      const date = document.getElementById("punishDate").value;
      const reason = document.getElementById("punishReason").value;
      if (!type || !date || !reason) return alert("Please fill out all punishment fields.");

      const staff = staffList.find(s => s.id === id);
      const updatedPunishments = [...(staff.punishments || []), { type, date, reason }];
      await updateDoc(doc(db, "staff", id), { punishments: updatedPunishments });
    }

    // ---- Remove punishment ----
    window.removePunishment = async function(id, index) {
      const staff = staffList.find(s => s.id === id);
      const updatedPunishments = [...(staff.punishments || [])];
      updatedPunishments.splice(index, 1);
      await updateDoc(doc(db, "staff", id), { punishments: updatedPunishments });
    }

    // ---- Delete staff ----
    window.deleteStaff = async function(id) {
      if (confirm("Are you sure you want to delete this staff member?")) {
        await deleteDoc(doc(db, "staff", id));
        backHome();
      }
    }

    // ---- Navigation ----
    window.login = login;
    window.addStaff = addStaff;
    window.backHome = function() {
      document.getElementById("staffPage").classList.add("hidden");
      document.getElementById("homePage").classList.remove("hidden");
    }
  </script>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Login Page -->
  <div id="loginPage" class="flex items-center justify-center h-screen">
    <div class="bg-white p-8 rounded shadow w-96">
      <h2 class="text-2xl font-bold mb-4">Admin Login</h2>
      <input type="password" id="loginCode" placeholder="Enter Admin Code" class="border w-full p-2 rounded mb-4">
      <button onclick="login()" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Login</button>
    </div>
  </div>

  <!-- Home Page -->
  <div id="homePage" class="hidden p-6">
    <div class="flex gap-4 mb-6">
      <button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" onclick="document.getElementById('staffListPage').classList.remove('hidden'); document.getElementById('addStaffPage').classList.add('hidden');">Staff Database</button>
      <button class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" onclick="document.getElementById('addStaffPage').classList.remove('hidden'); document.getElementById('staffListPage').classList.add('hidden');">Add Staff</button>
    </div>

    <!-- Staff List -->
    <div id="staffListPage">
      <h2 class="text-xl font-bold mb-2">Staff Database</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white shadow rounded">
          <thead class="bg-gray-200">
            <tr><th class='px-4 py-2'>Name</th><th class='px-4 py-2'>Discord</th><th class='px-4 py-2'>Roblox</th><th class='px-4 py-2'>Rank</th><th class='px-4 py-2'>Date Hired</th><th class='px-4 py-2'>Action</th></tr>
          </thead>
          <tbody id="staffTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Add Staff -->
    <div id="addStaffPage" class="hidden mt-6">
      <h2 class="text-xl font-bold mb-2">Add Staff</h2>
      <form id="addStaffForm" class="bg-white p-6 rounded shadow max-w-md">
        <input id="teachingName" placeholder="Teaching Name" class="border p-2 rounded w-full mb-2"><br>
        <input id="discord" placeholder="Discord User" class="border p-2 rounded w-full mb-2"><br>
        <input id="roblox" placeholder="Roblox User" class="border p-2 rounded w-full mb-2"><br>
        <input id="rank" placeholder="Rank" class="border p-2 rounded w-full mb-2"><br>
        <input id="dateHired" type="date" class="border p-2 rounded w-full mb-2"><br>
        <button type="button" onclick="addStaff()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Add Staff</button>
      </form>
    </div>
  </div>

  <!-- Staff Detail Page -->
  <div id="staffPage" class="hidden p-6">
    <div id="staffDetails"></div>
  </div>
</body>
</html>
